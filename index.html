<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Website</title>
    <!-- Favicon-->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css"/>
    <!-- DataTables JavaScript -->
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    
<!-- MIGHT NOT NEED DATATABLES FIXED HEADERS, take out if superfluous -->
    <!-- FixedHeader CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedheader/3.2.1/css/fixedHeader.dataTables.min.css"/>
    <!-- FixedHeader JavaScript -->
    <script type="text/javascript" src="https://cdn.datatables.net/fixedheader/3.2.1/js/dataTables.fixedHeader.min.js"></script>

</head>
<body>

    <div class="container">
    <h1>Time and Pay Tracker</h1>
    
    <div class="d-flex justify-content-between">
        <div>
            <button type="button" class="addPayPeriod btn btn-outline-primary"><i class="fa fa-plus me-1"></i>Add pay period</button>
        </div>
        <div>
            <button type="button" class="loadDemoData btn btn-outline-info"><i class="fa fa-save me-1"></i>Load demo data</button>
            <button type="button" class="clearLocalData btn btn-outline-danger"><i class="fa fa-trash me-1"></i>Clear all data</button>
        </div>
    </div>

    <div class="pp-form-container card-mp hidden">   
        <div class="card-title fw-bold mb-3">Pay Period</div>      
        <form id="payPeriodForm">
            <div class="mb-2">
                <label for="ppStartDate">Start Date</label>
                <input type="date" name="ppStartDate" class="form-control" id="ppStartDate">
            </div>
            <div class="mb-2">
                <label for="ppEndDate">End Date</label>
                <input type="date" name="ppEndDate" class="form-control" id="ppEndDate">
            </div>
            <div>
                <button type="button" class="ppDismiss btn btn-outline-secondary btn-sm">Close</button>
                <button type="button" class="ppSave btn btn-primary btn-sm" data-ppID="">Save</button>
            </div>
        </form>
    </div>

    <div class=" calendarContainer card-mp">
    <!-- calendar goes here -->
    </div>

    <div class="te-form-container card-mp hidden">
        <div class="card-title fw-bold">Time Entry</div>
        <form id="timeEntryForm">
            <div class="me-2 mt-3">
                <div class="mb-2">
                    <label for="startTime">Start time</label>
                    <input type="time" name="startTime" class="timeInp form-control form-control-sm">
                </div>
                <div class="mb-2">
                    <label for="endTime">End time</label>
                    <input type="time" name="endTime" class="timeInp form-control form-control-sm">
                </div>
                <div class="mb-2">
                    <label for="breakDuration">Break</label>
                    <input type="number" name="breakDuration" class="timeInp form-control form-control-sm" placeholder="0">
                </div>
                <div class="mb-2">
                    <label for="notes">Total</label>
                    <input type="number" name="dayTotal" class="form-control form-control-sm disabled" placeholder="0" readOnly>
                </div>
                <div class="d-flex justify-content-between">
                    <div>
                        <button type="button" class="dismissForm btn btn-outline-secondary btn-sm">Close</button>
                        <button type="button" class="saveFormInps btn btn-primary btn-sm" data-date="">Save</button>
                    </div>
                    <div>
                        <button type="button" class="deleteTimeRec btn btn-danger btn-sm"><i class="fa fa-trash me-1"></i>Delete time record</button>
                    </div>
                </div>
            </div>
        <form>
    </div>

</div>

            <!-- Bootstrap core JS-->
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
            <!-- Core theme JS-->
            <script src="js/scripts.js"></script>

    <script>
       
function setUpDemoData(){
    // define the demo data object
    let timeEntriesDemoData = {
            "2024-06-03": {
                "startTime": "08:00",
                "endTime": "16:00",
                "breakDuration": "30",
                "dayTotal": "7.50",
                "weekNumber": 22
            },
            "2024-06-04": {
                "startTime": "08:00",
                "endTime": "16:00",
                "breakDuration": "0",
                "dayTotal": "8.00",
                "weekNumber": 22
            },
            "2024-06-05": {
                "startTime": "08:00",
                "endTime": "16:00",
                "breakDuration": "0",
                "dayTotal": "8.00",
                "weekNumber": 22
            },
            "2024-06-06": {
                "startTime": "08:00",
                "endTime": "16:00",
                "breakDuration": "0",
                "dayTotal": "8.00",
                "weekNumber": 22
            },
            "2024-06-07": {
                "startTime": "08:00",
                "endTime": "16:00",
                "breakDuration": "30",
                "dayTotal": "7.50",
                "weekNumber": 21
            },
    };
    // store the demo data object in local storage
    localStorage.setItem('timeEntries', JSON.stringify(timeEntriesDemoData));
    // reload page
    location.reload();
}




        /* EVENTS */
            $(()=>{
                console.log("Hello World!");
                buildCalendar();
            })


            $(document).on('click', '.loadDemoData', function(){
                console.log("Load demo data button clicked!");
                setUpDemoData();

                let teData = getStoredDayData();
                console.log({teData});
            })

            $(document).on('click', '.clearLocalData', function(){
                console.log("Clear data button clicked!");
                // clear local storage
                localStorage.clear();
                // reload page
                location.reload();
            })

            $(document).on('click', '.addPayPeriod', function(){
                console.log("Add pay period button clicked!");
                // show the pay period form
                $('.pp-form-container').addClass('unhidden').removeClass('hidden');
                // make sure form is empty since this btn is for adding new pay periods
                $('#ppStartDate').val('');
                $('#ppEndDate').val('');
                $('#ppSave').data('ppID', '');
            })


            $(document).on('click', '.ppSave', function(){
                console.log("save pay period button clicked!");
                // get start and end dates for pay period from form and save to local storage
                let ppID = $(this).data('ppID');
                let startDate = $('#ppStartDate').val();
                let endDate = $('#ppEndDate').val();
                console.log({ppID});
                console.log({startDate});
                console.log({endDate});               

                savePayPeriodData(ppID, startDate, endDate);
                // hide the pay period form
                // $('.pp-form-container').addClass('hidden').removeClass('unhidden');
            })

            $(document).on('click', '.ppDismiss', function(){
                console.log("close pay period form button clicked!");
                // close the pay period form
                $('.pp-form-container').addClass('hidden').removeClass('unhidden');
            })

            $(document).on('change', '.timeInp', function(){
                // start time, end time, or break duration was modified...update total hours for day
                console.log("Time changed!");
                // retrieve values from form
                let start = $(this).closest('form').find('input[name="startTime"]').val();
                let end = $(this).closest('form').find('input[name="endTime"]').val();
                let breakTime = $(this).closest('form').find('input[name="breakDuration"]').val();
                // console.log({start});
                // console.log({end});
                // console.log({breakTime});
                // retrieve date from save btn
                let focusDate = $(this).closest('form').find('.saveFormInps').data('date');
                // let focusDate = $(this).closest('td').data('date');
                console.log({focusDate});'s'
                // retrieve total input field
                let total = $(this).closest('form').find('input[name="dayTotal"]');
                // console.log({total});
                // convert start/end times to datetime objects
                let startDateTime = new Date(`${focusDate}T${start}:00`);
                let endDateTime = new Date(`${focusDate}T${end}:00`);
                // console.log({startDateTime});
                // console.log({endDateTime});

                // calculate difference between start and end times (in minutes)
                let diffMinutes = (endDateTime - startDateTime) / 60000;
                // accommodate for break time
                let totalMinutes = diffMinutes - breakTime;
                // convert minutes to hours/minutes
                let hours = Math.floor(totalMinutes / 60);
                let minutes = totalMinutes % 60;
                // calculate total hours worked
                let totalTimeWorked = (hours + (minutes / 60)).toFixed(2);
                // console.log({totalTimeWorked});
                // populate total field
                total.val(totalTimeWorked);
            })

            $(document).on('click', 'td:not(:last-child)', function(){
                // add selected class to clicked cell
                $(this).addClass('selected');
                // remove selected class from other cells
                $('td').not(this).removeClass('selected');

                console.log("Clicked on a day!");       
                // get date from clicked cell
                let date = $(this).data('date');
                console.log({date});
                // store date in save button (or maybe somewhere better?)
                $('.saveFormInps').data('date', date);
                // get any existing data from local storage
                let timesheetData = getStoredDayData();
                let data = timesheetData[date] || {startTime: '', endTime: '', breakDuration: 0};
                // show form
                $('.te-form-container').addClass('unhidden').removeClass('hidden');
                
            // put date in form title for clarity (format date)
            // format date manually for now but think about using a library like date-fns or moment.js
                // Split the date string to reformat to us format
                let [year, month, day] = date.split("-");
                // Format the date as "DD/MM/YYYY"
                let formattedDate = `${month}/${day}/${year}`;
                console.log({formattedDate});
            // // //
                $('.te-form-container .card-title').text(`Time Entry for ${formattedDate}`);
                
                // populate form with existing data
                $('input[name="startTime"]').val(data.startTime);
                $('input[name="endTime"]').val(data.endTime);
                $('input[name="breakDuration"]').val(data.breakDuration);
                $('input[name="dayTotal"]').val(data.dayTotal);
                                        
            })
                
            $(document).on('click', '.dismissForm', function(){
                console.log("Close form!");
                // remove date from save button
                $('saveFormInps').data('date', '');
                // hide form
                $('.te-form-container').addClass('hidden').removeClass('unhidden');
            })

            $(document).on('click', '.saveFormInps', function(event) {
                console.log("Save button was clicked!");
              // grab data and save to local storage  
                // grab date from where it is stored after the td was clicked (stored on btn data attribute for now)
                let date = $(this).data('date');
                console.log({date});
                // define form
                let form = $(this).closest('form');
                console.log({form});
                // define form data
                let formData = {
                    startTime: form.find('input[name="startTime"]').val(),
                    endTime: form.find('input[name="endTime"]').val(),
                    breakDuration: form.find('input[name="breakDuration"]').val(),
                    dayTotal: form.find('input[name="dayTotal"]').val(),
                    weekNumber: getCalendarWeekNumber(new Date(date))               
                };
                console.log({date});
                console.log({formData});
                // Save the data to local storage
                saveDayData(date, formData);
            // Hide the form and update the ts summary
                // hide form
                $('.te-form-container').addClass('hidden').removeClass('unhidden');
                // find timeEntryCont div by date on td
                let tsCont = $(`td[data-date="${date}"] .timeEntryCont`);
                // define daySummary
                let daySummary = date ? `${formData.dayTotal} hrs` : `0`;
                console.log({daySummary});
                    // ? `${formData.startTime} - ${formData.endTime} (${formData.breakDuration} min break) Total: ${formData.dayTotal}, wkno: ${formData.weekNumber}` 
                // update td with new daySummary
                tsCont.html(`<div>${daySummary}</div>`);
            });

            $(document).on('click', '.ppTotalLink', function(){
                console.log("Pay period total clicked!");
                // get start and end dates for pay period from form and save to local storage
                // get pay period start and end dates from local storage...or maybe from the cell itself
                // to get from local storage we need to be able to reliably link the pay period total cell to the pay period start and end dates....maybe try using the end date as the key in local storage???
                // we would just need to implement a check upon saving that the end date is unique
                // !!!we need to use a unique id since the payperiod end date can be changed

                // get pay period data from local storage
                let payPeriodData = getStoredPayPeriodData();
                // let endDate = $(this).data('endDate');
                let ppID = $(this).data('ppID');
                // extract start and end dates from pay period data
                
                let startDate = payPeriodData[ppID].payPeriodStart;
                let endDate = payPeriodData[ppID].payPeriodEnd;
                console.log({startDate});
                console.log({endDate});               

                // show the pay period form
                $('.pp-form-container').addClass('unhidden').removeClass('hidden');
                // populate form with existing data
                $('#ppStartDate').val(startDate);
                $('#ppEndDate').val(endDate);
            })
      
        /* FUNCTIONS */

                //   // Function to create a table cell with a partial background and tabindex
                //   function createTableCell(content, className) {
                //       const td = document.createElement('td');
                //       if (className) {
                //         td.className = className;
                //       }
                //       td.textContent = content;
                //       td.tabIndex = 0; // Make the td focusable
                //       return td;
                //     }

                //     // Function to create a table row
                //     function createTableRow(cells) {
                //       const tr = document.createElement('tr');
                //       cells.forEach(cell => tr.appendChild(cell));
                //       return tr;
                //     }



            // usimg a while loop to loop through a date range
            // /*

// ****TO DO for pay period functionality:****

//             -have inputs for entering start and end dates for a new pay period
//             -have a button to submit the start and end dates
//             -have a function that calculates the pay period total based on the start and end dates (loop through dates in range and sum the day totals)
//             -have a function that styles the dates within the pay period (maybe add a class to the td elements)
//             -populate the pay period total cell with the total hours worked during the pay period
//             -to change the pay period click on the pay period total cell and modify the start and end dates

            // function to loop through a date range so that we can calculate the pay period total for the date range and also style the dates within the pay period
            function savePayPeriodData(ppID, startString, endString){

                // calculate the total hours worked during the pay period
                // loop through the dates in the range and sum the day totals
                // style the dates within the pay period
                // populate the pay period total cell with the total hours worked during the pay period
                // * To change the pay period click on the pay period total cell and modify the start and end dates


                let timesheetData = getStoredDayData();
                const start = new Date(startString);
                const end = new Date(endString);
                let loopDate = new Date(start);
                let ppTotal = 0; // initialize pay period total

                // if this is a new pay period, generate a unique id
                if(!ppID){
                    ppID = generateUniqueId();
                    console.log("New pay period ID: " + ppID);
                }

                // loop through the dates in the range
                // overview: get total hours worked for the day then add to total for pay period,
                //           also, determine location of date within pay period and update day data object with pay period info
                while(loopDate <= end){
                    console.log({loopDate});
                    // convert loopDate to string
                    let loopDateString = loopDate.toISOString().split('T')[0];

                    // if there is no data for this day, create a new object with default values
                    let dayData;
                    if(timesheetData[loopDateString]){ 
                        dayData = timesheetData[loopDateString];
                    } else { 
                        dayData = {startTime: '', 
                                    endTime: '', 
                                    breakDuration: 0, 
                                    dayTotal: 0};
                    }
                    console.log({dayData});

                    // add total hours from this day to total for pay period
                    if(dayData.dayTotal){
                        ppTotal = ppTotal + parseFloat(dayData.dayTotal);
                        console.log({ppTotal});
                    }

                    // determine location of date within pay period (start, end, middle)
                    if(loopDateString == startString){
                        var ppPosition = 'start';
                    } else if(loopDateString == endString){
                        var ppPosition = 'end';
                    } else {
                        var ppPosition = 'middle';
                    }
                    // update the day data object with pay period info
                    saveDayData(loopDateString, {...dayData, 
                                                payPeriod: ppPosition, 
                                                payPeriodStart: startString, 
                                                payPeriodEnd: endString, 
                                                ppID: ppID});

                    // increment the date
                    let newDate = loopDate.setDate(loopDate.getDate() + 1);
                    loopDate = new Date(newDate);         
                } // END loop

                // get pay period data from local storage
                let payPeriodData = getStoredPayPeriodData();
                // save pay period data (saving the total hours worked during the pay period)
                payPeriodData[ppID] = {
                    startDate: startString,
                    endDate: endString,
                    total: ppTotal
                }

                // save ppTotal to local storage
                localStorage.setItem('payPeriods', JSON.stringify(payPeriodData));

                // style the dates within the pay period...or maybe reload the calendar??? since we're going to be styling stuff when we build the calendar anyway
                // location.reload();

            }


            // create a basic unique id generator since we're not using a database
            function generateUniqueId() {
                return 'id-' + new Date().getTime();
            }

            // */
            function getFormattedDateString(dateObj) {
                // const date = new Date();

                let day = String(dateObj.getDate()).padStart(2, '0');
                let month = String(dateObj.getMonth() + 1).padStart(2, '0'); // Months are zero-based
                let year = dateObj.getFullYear();

                let formattedDate = `${year}-${month}-${day}`;
                console.log(formattedDate); // Example output: "2024-05-30"
                return formattedDate;
            }

            function getCalendarWeekNumber(date) {
                // Get the first day of the year
                const startOfYear = new Date(date.getFullYear(), 0, 1);
                
                // Find the first Sunday of the year
                const firstSunday = new Date(startOfYear);
                firstSunday.setDate(firstSunday.getDate() + (7 - firstSunday.getDay()) % 7);
                
                // Calculate the number of days between the date and the first Sunday of the year
                const daysBetween = Math.floor((date - firstSunday) / (24 * 60 * 60 * 1000));
                
                // Calculate the week number
                return Math.floor(daysBetween / 7) + 1;
            }

            function getCalendarWeekNumber_v3(date) {
                console.log({date});
                let startOfYear = new Date(date.getFullYear(), 0, 1);
                console.log({startOfYear});
                // Adjust startOfYear to the first Sunday of the year
                let firstSunday = new Date(startOfYear.setDate(startOfYear.getDate() - startOfYear.getDay() + 7));
                console.log({firstSunday});
                // Calculate the number of days between the date and the first Sunday of the year
                let daysBetween = Math.floor((date - firstSunday) / (24 * 60 * 60 * 1000));
                console.log({daysBetween});
                // Calculate the week number
                return Math.floor(daysBetween / 7) + 1;
            }

            // Function to pad a number to two digits
            function padToTwoDigits(number) {
                    return number.toString().padStart(2, '0');
                }

            // retrieve data from local storage
            function getStoredDayData(){
                var timesheetData = localStorage.getItem('timeEntries');
                return timesheetData ? JSON.parse(timesheetData) : {};
            }


            function getStoredPayPeriodData(){
                var payPeriodData = localStorage.getItem('payPeriods');
                return payPeriodData ? JSON.parse(payPeriodData) : {};
            }

            // save data to local storage
            function saveDayData(date, data){
                var timesheetData = getStoredDayData();
                timesheetData[date] = data;
                console.log({timesheetData});
                localStorage.setItem('timeEntries', JSON.stringify(timesheetData));
            }


            // Function to build the calendar
            function buildCalendar(){
                // set values of current day/month/year
                let today = new Date();
                let currentMonth = today.getMonth() + 1;
                let currentYear = today.getFullYear();
                // console.log({today});
                // console.log({currentMonth});
                // console.log({currentYear});

                // set calendar container
                let calendarDiv = $(".calendarContainer");

                // set up calendar title
                let monthNames = ['January', 'February', 'March', 'April', 'May', 'June','July', 'August', 'September', 'October', 'November', 'December'];
                let calendarTitle = $('<div class="calendar-title text-center"></div>').text(`${monthNames[currentMonth - 1]} ${currentYear}`);
                calendarDiv.append(calendarTitle);

                // set up calendar table
                let daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                let firstDayInMonth = new Date(currentYear, currentMonth, 1).getDay();
                // console.log({daysInMonth});                
                // console.log({firstDayInMonth});
                let tbl = $('<table class="calendar table table-cell-hover table-cell-focus" id="myCalendar"></table>');
                let tblHead = $('<thead></thead>');
                let tblBody = $('<tbody></tbody>');
                
                // set up table header
                let daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat','Weekly Total','Pay Period Total'];
                let headerRow = $('<tr></tr>');
                $.each(daysOfWeek, (i, v) => {
                    let th = $('<th></th>').text(v);
                    headerRow.append(th);
                })
                tblHead.append(headerRow);
                
                // get stored pay period data so we can populate the calendar with pay period totals and style the pay period dates
                let ppData = getStoredPayPeriodData();
                // set up table body
                let dx = 1;
                for (let i = 0; i < 6; i++) {
                    // console.log("--------------------");
                    let bodyRow = $('<tr></tr>');
                    let payPeriodTotal = false; // initialize pay period total variable for this week (should ideally only have one pay period total per week)
                    for (let j = 0; j < 7; j++) {
                        // console.log("j is: " + j);
                        let dateString = `${currentYear}-${padToTwoDigits(currentMonth)}-${padToTwoDigits(dx)}`;
                        // console.log({dateString});
                        let weekNum = getCalendarWeekNumber(new Date(dateString));                
                        let cell = $(`<td class="cal-day" data-date="${dateString}"></td>`);
                        if (i === 0 && j < firstDayInMonth) {
                            cell.text('');
                        } else if (dx < daysInMonth) {
                            cell.dayDate = dx + 1;
                            cell.html(`<div class="fw-bold">${dx}</div>
                                        <div class="timeEntryCont"></div>`);
                            let existingData = getStoredDayData();
                            console.log({existingData});
                            let data = existingData[dateString] ? existingData[dateString] : {startTime: '', endTime: '', breakDuration: 0};
                            // console.log({data});
                            if(data.dayTotal){
                                let tsCont = cell.find('.timeEntryCont');
                                // tsCont.html(`${data.startTime} - ${data.endTime} (${data.breakDuration} min break) Total: ${data.dayTotal} hrs`);
                                tsCont.html(`${data.dayTotal} hrs`);
                            }

                            let dayPpID = data.ppID;
                            console.log({dayPpID});
                            // style the cell if it is part of a pay period
                            if(data.payPeriod){
                                cell.addClass('pp-day');
                                if(data.payPeriod == 'start'){
                                    cell.addClass('pp-start');
                                } else if(data.payPeriod == 'end'){
                                    cell.addClass('pp-end');
                                } else {
                                    cell.addClass('pp-middle');
                                }
                            }

                            // add pay period total to pay period total cell at end of this row if this day is the end of a pay period
                            // if(ppData[dayPpID] && ppData[dayPpID].endDate == dateString){ 
                            if(ppData[dayPpID]){   
                                payPeriodTotal = ppData[dayPpID].total; 
                              
                                console.log({dayPpID});
                                console.log({payPeriodTotal});
                            
                                console.log({data});
                                console.log({ppData});
                            }
                            dx++;
                        }
                        bodyRow.append(cell);
                        // if there are 7 cells in the row, add the weekly total and pay period total cells
                        if(j === 6){
                            // if there is a pay period total for this week add total amt to pp total cell
                            if(payPeriodTotal){
                                bodyRow.append(`<td class="week-total"></td>
                                                <td class="pp-total"><a href="#" class="ppTotalLink" data-endDate="${dateString}">${payPeriodTotal} hrs</a></td>`);
                            // if there is no pay period total for this week add empty cells
                            } else {
                                bodyRow.append(`<td class="week-total"></td>
                                                <td class="pp-total"></td>`);
                            }
                        }
                    }
                    tblBody.append(bodyRow);
                }
                tbl.append(tblHead);
                tbl.append(tblBody);
                calendarDiv.append(tbl);
            }

    </script>


</body>
</html>

