<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Website</title>
    <!-- Favicon-->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css"/>
    <!-- DataTables JavaScript -->
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    
<!-- MIGHT NOT NEED DATATABLES FIXED HEADERS, take out if superfluous -->
    <!-- FixedHeader CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedheader/3.2.1/css/fixedHeader.dataTables.min.css"/>
    <!-- FixedHeader JavaScript -->
    <script type="text/javascript" src="https://cdn.datatables.net/fixedheader/3.2.1/js/dataTables.fixedHeader.min.js"></script>

</head>
<body>

<div class="container">
    <h1>Time and Pay Tracker</h1>
    
    <div class="d-flex justify-content-between">
        <div>
            <!-- decide if we want add pay period button above or below the calendar -->
            <!-- <button type="button" class="addPayPeriod btn btn-outline-primary"><i class="fa fa-plus me-1"></i>Add pay period</button> -->
        </div>
        <div class="mx-3">
            <button type="button" id="loadDemoData" class="loadDemoData btn btn-outline-info"><i class="fa fa-snowplow me-1"></i>Load demo data</button>
            <button type="button" id="clearLocalData" class="clearLocalData btn btn-outline-danger"><i class="fa fa-triangle-exclamation me-1"></i>Clear all data</button>
        </div>
    </div>

    <div class="te-form-container card-mp toggleContainer hidden">
        <div class="card-title fw-bold">Time Entry</div>
        <form id="timeEntryForm">
            <input type="hidden" name="timeEntryDate" id="timeEntryDate" value="">
            <div class="me-2 mt-3">
                <div class="mb-2">
                    <label for="startTime">Start time</label>
                    <input type="time" name="startTime" id="startTime" class="form-control form-control-sm timeInp reqInputs">
                </div>
                <div class="mb-2">
                    <label for="endTime">End time</label>
                    <input type="time" name="endTime" id="endTime" class="form-control form-control-sm timeInp reqInputs">
                </div>
                <div class="mb-2">
                    <label for="breakDuration">Break</label>
                    <input type="number" name="breakDuration" id="breakDuration" class="form-control form-control-sm timeInp" placeholder="0">
                    <div class="form-text">minutes</div>
                </div>
                <div class="mb-2">
                    <!-- might be abkle to use form-control-static to display plain text here for the calculated day total instead of having an input that you need to disable...then again, we do want to save the day total when we submit the form, but this is still technically an input, so it might actually work... -->
                    <label for="dayTotal">Total</label>
                    <input type="number" name="dayTotal" class="form-control form-control-sm disabled" placeholder="0" readOnly>
                    <div class="form-text">hours</div>
                </div>
                <div class="d-flex justify-content-between mt-3">
                    <div>
                        <button type="button" id="closeTimeEntryForm" class="dismissForm btn btn-outline-secondary btn-sm">Close</button>
                        <button type="button" id="saveTimeEntry" class="btn btn-primary btn-sm" data-date="">Save</button>
                    </div>
                    <div>
                        <button type="button" id="delTimeEntry" class="btn btn-danger btn-sm"><i class="fa fa-trash me-1"></i>Delete time entry</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class=" calendarContainer card-mp">
        <!-- calendar goes here -->
    </div>

    <div class="mx-3">
        <button type="button" id="addPayPeriod" class="addPayPeriod btn btn-outline-primary"><i class="fa fa-plus me-1"></i>Add pay period</button>
    </div>

    <div class="pp-form-container card-mp toggleContainer hidden">   
        <div class="card-title fw-bold mb-3">
            Pay Period
        </div>      
        <form id="payPeriodForm">
            <input type="hidden" name="payPeriodID" id="payPeriodID" class="testClass" value="">
            <div class="mb-2">
                <label for="ppStartDate">Start Date</label>
                <input type="date" name="ppStartDate" id="ppStartDate" class="testClass form-control reqInputs">
            </div>
            <div class="mb-2">
                <label for="ppEndDate">End Date</label>
                <input type="date" name="ppEndDate" id="ppEndDate" class="testClass form-control reqInputs">
            </div>
            <div class="d-flex justify-content-between mt-3">
                <div>
                    <button type="button" id="closePayPeriodForm" class="dismissForm btn btn-outline-secondary btn-sm">Close</button>
                    <button type="button" id="savePayPeriod" class="btn btn-primary btn-sm" data-ppID="">Save</button>
                </div>
                <div>
                    <button type="button" id="delPayPeriod" class="btn btn-danger btn-sm"><i class="fa fa-trash me-1"></i>Delete pay period</button>
                </div>
            </div>
        </form>
    </div>
    <div class="toast-container position-fixed"></div>
</div>

<!-- Bootstrap core JS-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Core theme JS-->
<script src="js/scripts.js"></script>

<script src="js/btnObj.js"></script>


<script>
/* 
*
* EVENTS 
*
*/

// Define global object to hold application data...so we don't have to repeatedly retrieve data from local storage...
const AppData = {
    timeEntryData: {},
    payPeriodData: {}
};

            $(()=>{
                // Initialize data on application load
                initializeData();

                // build the calendar
                buildCalendar();
            })

            // delete time entry
            $(document).on('click', '#delTimeEntry', function(){
                console.log("Delete time entry button clicked!");
                // delete confirmation
                let delBf = btnFlare($(this));

                if(getResponsiveClasses() == 'lg'){
                    delBf.confirm('confirmDelTe','Confirm Delete','danger','Are you sure you want to delete this time entry?');
                }else{
                    delBf.confirmSmall('confirmDelTe','danger','Are you sure you want to delete this time entry?');
                }
            })

            // delete time entry confirmation
            $(document).on('click', '.confirmDelTe', function(){
                console.log("Delete time entry confirm button clicked!");
                // get date from form hidden input
                let dateString = $(this).closest('form').find('input[name="timeEntryDate"]').val();
                console.log({dateString});
                
                // clear time entry record: clear out start time, end time, break duration, and day total
                //  also updates pay period total if day is within existing pay period
                clearTimeEntryRec(dateString);
                console.log("outside of clearTimeEntry!");

                // reload page (since we're styling the calendar based on pay period data)
                window.location.reload();
            })

            // delete pay period
            $(document).on('click', '#delPayPeriod', function(){
                console.log("Delete pay period button clicked!");
                // delete confirmation
                let delBf = btnFlare($(this));

                if(getResponsiveClasses() == 'lg'){
                    delBf.confirm('confirmDelPp','Confirm Delete','danger','Are you sure you want to delete this pay period?');
                }else{
                    delBf.confirmSmall('confirmDelPp','danger','Are you sure you want to delete this pay period?');
                }
                
            })

            // delete pay period confirmation
            $(document).on('click', '.confirmDelPp', function(){
                // get pay period ID from form hidden input
                let ppID = $(this).closest('form').find('input[name="payPeriodID"]').val();
                console.log({ppID});

                // get time entry records with given ppid from local storage
                // clear out ppid, ppPosition, ppStartDate, and ppEndDate from time entry records
                let timeEntryData = getStoredDayData();
                console.log({timeEntryData});   
                for (const [date, dayData] of Object.entries(timeEntryData)) {
                    if(dayData.ppID == ppID){
                        console.log({dayData});
                        console.log("Updating pay period info for daily records that are no longer in pay period");
                        saveDayData(date, {...dayData, 
                                            ppID: '',
                                            ppPosition: '', 
                                            ppStartDate: '', 
                                            ppEndDate: ''
                                        })
                        // // console.log({dayData});
                        // let myNewDayData = getStoredDayData(); // just for testing
                        // console.log({myNewDayData});
                    }
                }

                // delete pay period record
                deletePayPeriodRec(ppID);

                // // reload page (since we're styling the calendar based on pay period data)
                window.location.reload(); // KEEP ME! just commented out while testing
            })

            // load demo data into local storage
            $(document).on('click', '#loadDemoData', function(){
                console.log("Load demo data button clicked!");
                // manually pass in current month for now...later switch to calculating it inside the set up demo data function...
                let month = "08";
                setUpDemoData(month);
                // see if setup worked
                // let teData = AppData.timeEntryData; // just for testing
                // console.log({teData});
            })

            // clear all data from local storage
            $(document).on('click', '#clearLocalData', function(){
                console.log("Clear data button clicked!");
                // clear local storage
                localStorage.clear();
                // reload page
                window.location.reload();
            })

            $(document).on('click', '#addPayPeriod', function(){
                console.log("Add pay period button clicked!");
                // show the pay period form
                $('.pp-form-container').addClass('unhidden').removeClass('hidden');

                // make sure form is empty and validation reset since this btn is for adding new pay periods
                resetInvalidForm($('#payPeriodForm'));
                resetForm($('#payPeriodForm'));
                toggleDisabled('#delPayPeriod');
            })

            $(document).on('click', '#savePayPeriod', function(){
                console.log("save pay period button clicked!");
                // get start and end dates for pay period from form and save to local storage
                let ppID = $('#payPeriodID').val();;
                let startDate = $('#ppStartDate').val();
                let endDate = $('#ppEndDate').val();
                // console.log({ppID});
                // console.log({startDate});
                // console.log({endDate});
                
                // added promise to loopPpDateRange so we can reload the page after the data is saved
                // ...will be helpful if we end up saving the data to the server instead of local storage    
                loopPpDateRange(ppID, startDate, endDate)
                    .then(() => {
                        console.log("Data saved successfully!");
                        // Reload the page after data is saved so dates within the updated pay period caan be styled appropriately
                        window.location.reload();
                    })
                    .catch((error) => {
                        console.error("Error saving data:", error);
                        // Error handling
                    });
            })

            $(document).on('click', 'td:not(:last-child)', function(){
            // $(document).on('click', 'td:not(:nth-last-child(-n+2))', function(){

              // !!!!!!!!!!!!!!!!!!!!!!!!!
              // *** maybe TO DO: unselect td if clicked on after already selected?????
                if($(this).hasClass('selected')){
                    $(this).removeClass('selected');
                    $('.te-form-container').addClass('hidden').removeClass('unhidden'); // KEEP ME! just commented out while testing
                }else{
                    // add selected class to clicked cell
                    $(this).addClass('selected');
                    // remove selected class from other cells
                    $('td').not(this).removeClass('selected');
                    // reset form
                    resetInvalidForm($('#timeEntryForm'));
                    console.log("Clicked on a day!");  
                    // re-enable delete time entry button
                    $('#delTimeEntry').removeClass('disabled');
                    
                    // get date from clicked cell
                    let dateString = $(this).data('date');
                    console.log({dateString});
                    // store date in save button (or maybe somewhere better?)
                    $('#timeEntryDate').val(dateString);
                    // get any existing time entry data from local storage
                    let timeEntryData = AppData.timeEntryData;
                    let dayData = timeEntryData[dateString] ? timeEntryData[dateString] : {startTime: '', endTime: '', breakDuration: 0};
                
                // if no start time and no end time saved, disable the delete time entry button...otherwise, make sure it is enabled
                    //  note: this seems to be the best way to check for existing time entry records with actual time entry data (validation requires both start and end times before saving, but allow clearing if either exists as a backup for cleaning up anything that gets broken)
                    //      (could have a time entry rec if part of a pay period but no time entry info has been entered yet
                    //          ...don't need option to delete time entry rec in this case
                    //          ...plus we're not actually 'deleting' a rec, we're just 'clearing' the time entry info (and leaving any pay period related info to enable easier styling of calendar))
                    if(dayData.startTime == '' && dayData.endTime == ''){
                        $('#delTimeEntry').addClass('disabled');
                    }
                    // show form
                    $('.te-form-container').addClass('unhidden').removeClass('hidden');
                    
                    // put formatted date in form title for clarity
                    //  ***format date manually for now, but think about using a library like date-fns or moment.js
                    let formattedDate = usDateFormat(dateString);
                    console.log({formattedDate}); // // //
                    $('.te-form-container .card-title').text(`Time Entry for ${formattedDate}`);
                    // populate form with any existing data
                    $('input[name="startTime"]').val(dayData.startTime);
                    $('input[name="endTime"]').val(dayData.endTime);
                    $('input[name="breakDuration"]').val(dayData.breakDuration);
                    $('input[name="dayTotal"]').val(dayData.dayTotal);
                    // scroll to form
                    $('#timeEntryForm')[0].scrollIntoView({ behavior: 'smooth' });
                }               
                
            })

            // close form
            $(document).on('click', '.dismissForm', function(){
                // uses a generic event to close forms
                console.log("Generic closing form event!");
                // hide form
                let container = $(this).closest('.toggleContainer');
                container.addClass('hidden').removeClass('unhidden');
                // reset invalid styling/feedback
                let form = container.find('form');
                resetInvalidForm(form);
            })

            // save time entry            
            $(document).on('click', '#saveTimeEntry', function(event) {
                console.log("Save button was clicked!");
                // check to make sure start/end times are not empty
                dayCheckEmptyInputs();
                if(!dayCheckEmptyInputs()){
                    return;
                }

              // grab data and save to global object/local storage  
                // define form
                let form = $(this).closest('form');
                // define form data (individual items passed to saveDayData func since we're keeping some of the existing day data)
                let formData = {
                    startTime: form.find('input[name="startTime"]').val(),
                    endTime: form.find('input[name="endTime"]').val(),
                    breakDuration: form.find('input[name="breakDuration"]').val(),
                    dayTotal: form.find('input[name="dayTotal"]').val()              
                };
                // grab date from where it is stored after the td was clicked (stored on btn data attribute for now)
                let dateString = form.find('input[name="timeEntryDate"]').val();

            // make sure not to overwrite any existing pay period info within the time entry record...
            // we're doing this when we only pass in form data (which only includes time entry info)
            // need to find out if we can make this a smarter process, for now just retrieve the existing data and overwrite the time entry info with data from form
                let dayData = AppData.timeEntryData[dateString];

            // Save the data to global object/local storage
                // use the '...dayData' syntax to keep existing data and then explicitly define each form input value for the time entry data that we're updating using the form
                saveDayData(dateString, {
                    ...dayData,
                    startTime: formData.startTime,
                    endTime: formData.endTime,
                    breakDuration: formData.breakDuration,
                    dayTotal: formData.dayTotal
                });

            // Hide the form and update the day summary
                // hide form
                $('.te-form-container').addClass('hidden').removeClass('unhidden'); // KEEP ME! just commented out while testing

                // find timeEntryCont div by date on td
                let tsCont = $(`td[data-date="${dateString}"] .timeEntryCont`);
                // define daySummary
                let daySummary = dateString ? `${formData.dayTotal} hrs` : `0`;
                // update td with new daySummary
                tsCont.html(`<div>${daySummary}</div>`);

            // Update pay period if it exists
                // check to see if date is within an existing pay period
                let ppID = dayIsInPayPeriod(dateString);
                if(ppID){
                    // loop through dates in pay period and recalculate total hours for pay period
                    loopPpDateRange_v2(ppID);
                    
                    // ?????need to reload entire calendar??? 
                    // window.location.reload();
                    // ?????or can we just update the pay period total cell?...
                    //  would have to update just the pp total link since we're leaving it open to have multiple pay periods within a single week...
                    //  this is what the link looks like:
                    //      <div><a href="#" class="ppTotalLink" title="${ppRange}" data-enddate="${dateString}" data-ppid="${dayPpID}">${payPeriodTotal} hrs</a></div>
                    
                    // update pay period total link (instead of reloading entire calendar)
                    let newPpTotal = AppData.payPeriodData[ppID].total;
                    // console.log ({newPpTotal});
                    // find link for corresponding pay period
                    let ppLink = $(`a[data-ppid="${ppID}"].ppTotalLink`);
                    // update text of pay period total link so we don't have to reload entire calendar
                    if(ppLink.length){
                        ppLink.text(newPpTotal);
                    }
                    // console.log(ppLink);
                // }else{ 
                //     console.log('date is NOT within an existing pay period!');
                }

            });

            $(document).on('click', '.ppTotalLink', function(){
                console.log("Pay period total clicked!");
                // show the pay period form
                $('.pp-form-container').addClass('unhidden').removeClass('hidden');
                // reset form
                resetInvalidForm($('#payPeriodForm'));
                // make sure delete pay period button is re-enabled
                toggleDisabled('#delPayPeriod', false);

                // get pay period data from local storage
                let payPeriodData = getStoredPayPeriodData();
                console.log({payPeriodData});
                let ppID = $(this).data('ppid');
                console.log({ppID});

                // extract start and end dates from pay period data
                let startDate = payPeriodData[ppID].startDate;
                let endDate = payPeriodData[ppID].endDate;
                console.log({startDate});
                console.log({endDate});               

                // populate form with the existing data
                $('#payPeriodID').val(ppID);
                $('#ppStartDate').val(startDate);
                $('#ppEndDate').val(endDate);
                // scroll to form
                $('#payPeriodForm')[0].scrollIntoView({ behavior: 'smooth' });
            })
      
            $(document).on('change', '.reqInputs', function(){
                console.log("Pay period input changed!");
                // remove invalid feedback styling when input is changed, user doesn't need to be told the input is invalid if they're actively trying to fix it
                if($(this).hasClass('is-invalid')){
                    invalidInput($(this), false);
                }
            })

            $(document).on('change', '.timeInp', function(){
                // update day total when time inputs are changed
                let changedInput = $(this);
                console.log({changedInput});
                console.log(changedInput);
                refreshDayTotal($(this));
            })


            $(document).on('click', '.changeMonth', function(){
                console.log("move between month button clicked!");
                // find out which direction we're moving from btn id
                let btnId = $(this).attr('id');
                console.log({btnId});

                // get the currently displayed month from the calendar
                let displayMonth = $('#myCalendar').data('month');
                console.log({displayMonth});
                let displayYear = $('#myCalendar').data('year');
                console.log({displayYear});

                if (btnId == 'nextMonth') {
                    // increment month
                    displayMonth++;
                    console.log({displayMonth});

                    // if currently displayed month is December, increment year and reset month to January
                    // (we're using 0-11 for months, so December is 11)
                    if(displayMonth > 11){
                        displayMonth = 0;
                        displayYear++;
                    }
                } else {
                    // decrement month
                    displayMonth--;
                    console.log({displayMonth});

                    // if currently displayed month is January, decrement year and reset month to December
                    // (we're using 0-11 for months, so January is 0) 
                    if(displayMonth < 0){
                        displayMonth = 11;
                        displayYear--;
                    }
                }

                // January is 0, December is 11
                if((displayMonth < 0 || displayMonth > 11) || (displayYear < 1900 || displayYear > 2100)){
                    console.log("Invalid month/year value!");
                    return;
                }else{
                    // clear out existing calendar from container
                    $('.calendarContainer').empty();
                    // reload calendar with new month
                    buildCalendar(displayMonth, displayYear);
                }

            })

/* 
*
* FUNCTIONS 
*
*/

// Function to initialize data from local storage
function initializeData() {
    console.log('hey there! we initializing the data!');
    AppData.timeEntryData = getStoredDayData();
    AppData.payPeriodData = getStoredPayPeriodData();

}

// Function to get time entry data from local storage
function getStoredDayData() {
    console.log('we getting the stored time entry data!');
    let data = localStorage.getItem('timeEntries');
    return data ? JSON.parse(data) : {};
}

// Function to get pay period's data from local storage
function getStoredPayPeriodData() {
    console.log('we getting the stored pay period data!');
    let data = localStorage.getItem('payPeriods');
    return data ? JSON.parse(data) : {};
}

// Function to save time entry data to local storage and update the global object
function saveDayData(date, data) {
    console.log('we saving the time entry data!');
    AppData.timeEntryData[date] = data; // update global object timeEntryData property
    localStorage.setItem('timeEntries', JSON.stringify(AppData.timeEntryData)); // reset local storage timeEntries item using updated object
}

// Function to save pay period data to local storage and update the global object
function savePayPeriodData(ppID, data) {
    console.log('we saving the pay period data!');
    AppData.payPeriodData[ppID] = data; // update global object payPeriodData property
    localStorage.setItem('payPeriods', JSON.stringify(AppData.payPeriodData)); // reset local storage payPeriods item using updated object
}

// update the pay period total, 
// used when saving pay period via form when increment is true (looping through all days within pay period and adding up totals for the day to replace existing value (if any) 
// also used when clearing a time entry record (just subtracting the total hours for the day we're clearing from the total for the pay period)
// 
function updatePayPeriodTotal(ppID, dateString, increment=true){
    // basically creating some more objects here simply for the purposes of code variable simplicity...
    // ...it does, however, allow us to just send the data for the pay period of interest to the savePayPeriodData() function, which means we have a standardized method for saving pay period data
    //   ...as opposed to updating the global object within this function, we do the updating of the global object and the local storage in a universal function
    let timeEntryData = AppData.timeEntryData;
    let payPeriodData = AppData.payPeriodData;

    if(payPeriodData[ppID] && timeEntryData[dateString]){
        // get total for given date
        let dayData = timeEntryData[dateString];
        let dayTotal = parseFloat(dayData.dayTotal);

        // add/subtract day total to/from pay period total in our local object
        if(increment){
            payPeriodData[ppID].total += dayTotal;
        }else{
            payPeriodData[ppID].total -= dayTotal;
        }

        // update the global object and local storage for the pay period data
        savePayPeriodData(ppID, payPeriodData[ppID]);
    }
}

function loopPpDateRange_v2(ppID){
    /*
    calculate the total hours worked during the pay period
    loop through the dates in the range and sum the day totals
    populate the pay period total cell with the total hours worked during the pay period
    */
   // *** this one is used when we're updating a time entry record and need to update the pay period total
  
    // get pay period data from object
    let payPeriodData = AppData.payPeriodData;
    let startString = payPeriodData[ppID].startDate;
    let endString = payPeriodData[ppID].endDate;
    console.log({startString});
    console.log ({endString});
    
    // get daily time entries from object
    let timeEntryData = AppData.timeEntryData;
    const start = new Date(startString);
    const end = new Date(endString);
    let loopDate = new Date(start);
    let ppTotal = 0; // initialize pay period total


  // loop through the dates in the range
    // overview: get total hours worked for the day then add to total for pay period,
    //           also, determine location of date within pay period and update day data object with pay period info
    while(loopDate <= end){
        console.log({loopDate});
        // convert loopDate to string
        let loopDateString = loopDate.toISOString().split('T')[0];

        // if there is no data for this day, create a new object with default values
        // ...to make pay period easier to deal with when we need to loop through dates in pay period range
        let dayData;
        if(timeEntryData[loopDateString]){ 
            dayData = timeEntryData[loopDateString];
        } else { 
            dayData = {
                startTime: '', 
                endTime: '', 
                breakDuration: 0, 
                dayTotal: 0
            };
        }
        console.log({dayData});

        // add total hours from this day to total for pay period
        if(dayData.dayTotal){
            ppTotal = ppTotal + parseFloat(dayData.dayTotal);
            console.log({ppTotal});
        }

        // increment the date
        loopDate.setDate(loopDate.getDate() + 1);         
    } // END loop

  // save pay period data (saving the total hours worked during the pay period)
    // update global object and local storage at same time
    savePayPeriodData(ppID, {
        startDate: startString,
        endDate: endString,
        total: ppTotal
    });

    let newPayPeriodData = AppData.payPeriodData[ppID]; // just for testing
    console.log({newPayPeriodData});

    // return ppTotal;
}


// function to loop through a date range 
// so that we can calculate the pay period total for the date range 
// and also style the dates within the pay period
function loopPpDateRange(ppID, startString='', endString=''){
    /*
    calculate the total hours worked during the pay period
    loop through the dates in the range and sum the day totals
    style the dates within the pay period
    populate the pay period total cell with the total hours worked during the pay period
    */
    // other notes:
    // ***might not need this chunk all of the time if we make this a multi use function 
    // (currently use when we add/edit a pay period and might also possibly use when when update a time entry record so that the pay period total can be recalculated)
    // .....for now we're just going to create a separate function for looping through dates to update pay period total in the context of updating a time entry...
    // .....updating the given time entry and the pay period total is ALL that we want to do in THAT case

    console.log({ppID});
  // move outside of function so we can use the looping in multiple locations?????...maybe cancel that thought...
    // get pay period data from object
    let payPeriodData = AppData.payPeriodData;
    // pay period validation
    if(!payPeriodValidation(ppID, startString, endString, payPeriodData)){
        // if pay period validation fails, exit the function
        console.warn("pay period form validation failed!");
        return;
    // }else{
    //     console.log("pay period form validation passed!");
    }
    
    // get daily time entries from object
    let timeEntryData = AppData.timeEntryData;
    const start = new Date(startString);
    const end = new Date(endString);
    let loopDate = new Date(start);
    let ppTotal = 0; // initialize pay period total

    // if this is a new pay period, generate a unique id
    if(!ppID){
        ppID = generateUniqueId();
        // console.log("New pay period ID: " + ppID);
    }

  // loop through the dates in the range
    // overview: get total hours worked for the day then add to total for pay period,
    //           also, determine location of date within pay period and update day data object with pay period info
    while(loopDate <= end){
        // console.log({loopDate});
        // convert loopDate to string
        let loopDateString = loopDate.toISOString().split('T')[0];

        // if there is no data for this day, create a new object with default values
        // ...to make pay period easier to deal with when we need to loop through dates in pay period range
        let dayData;
        if(timeEntryData[loopDateString]){ 
            dayData = timeEntryData[loopDateString];
        } else { 
            dayData = {
                startTime: '', 
                endTime: '', 
                breakDuration: 0, 
                dayTotal: 0
            };
        }
        // console.log({dayData});

        // add total hours from this day to total for pay period
        if(dayData.dayTotal){
            ppTotal = ppTotal + parseFloat(dayData.dayTotal);
            // console.log({ppTotal});
        }

        /////////***
        // determine location of date within pay period (start, end, middle)...this allows us to cheat and style days easier once we save to individual days...
        let ppPosition;
        if(loopDateString == startString){
            ppPosition = 'start';
        } else if(loopDateString == endString){
            ppPosition = 'end';
        } else {
            ppPosition = 'middle';
        }
        // update the day data with pay period info
        saveDayData(loopDateString, {
            ...dayData, 
            ppID: ppID,
            ppPosition: ppPosition, 
            ppStartDate: startString, 
            ppEndDate: endString
        });
        /////////

        // increment the date
        loopDate.setDate(loopDate.getDate() + 1);         
    } // END loop for dates in range


    // added promise in case we end up saving the data to the server instead of local storage
    return new Promise((resolve, reject) => {
        try {
            // console.log("inside the loopPpDateRange() Promise!");
          // save pay period data (saving the total hours worked during the pay period)
            // update global object and local storage at same time
            savePayPeriodData(ppID, {
                startDate: startString,
                endDate: endString,
                total: ppTotal
            });

            // update pay period info in daily records that are not in this new pay period (but were in the old pay period)
            for (const [date, dayData] of Object.entries(timeEntryData)) {
                let dayDate = new Date(date);

                if(dayData.ppID == ppID && (dayDate < start || dayDate > end)){
                    // console.log("Updating pay period info for daily records that are not in new pay period");
                    saveDayData(date, {...dayData, 
                                        ppID: '',
                                        ppPosition: '', 
                                        ppStartDate: '', 
                                        ppEndDate: ''
                                    })
                }
            }
            // resolve the promise
            resolve();

        } catch (error) {
                    reject(error);
        }
    });

    // reload is done outside of this function--reload allows us to easily style the calendar based on pay period data (styling is done when building the calendar anyway)
    // it will probably be better than selectively updating the styling
}

// delete a single pay period record from local storage
function deletePayPeriodRec(ppID){
    // get pay period data from global object
    let payPeriodData = AppData.payPeriodData;

    if(payPeriodData && payPeriodData[ppID]){
        // delete pay period record from object
        delete payPeriodData[ppID];
        // update local storage so record is deleted
        localStorage.setItem('payPeriods', JSON.stringify(payPeriodData));
    }
}

// checks if day is within an existing pay period, returns pay period ID if date within existing pay period, false otherwise
function dayIsInPayPeriod(dateString){
    let ppID = false;
    if(AppData.timeEntryData[dateString]){
        let dayData = AppData.timeEntryData[dateString];
        if(dayData.ppID && dayData.ppID != ''){
            ppID = dayData.ppID;
        }
    }

    return ppID;
}

// clear a single time entry record from local storage
// NOTE: don't want to delete time entry record if it already exists...
// ...it may be part of a pay period and the way we have pay period styling for the calendar td's set up right now references info in the daily time entry record...
// ...if this seems too goofy, we'd just have to find a way to dynamically determine if day is part of pay period when calendar is being built...
// ...maybe investigate later...for now let's stick to how we have it currently set up...
function clearTimeEntryRec(dateString){
    // get time entry data from global object
    let timeEntryData = AppData.timeEntryData;

    if(timeEntryData && timeEntryData[dateString]){
        // if time entry record has a ppid, locate the pay period record for the given ppid
        // and subtract total for day from pay period record total and update record
        let ppID = dayIsInPayPeriod(dateString);
        // update pay period total if date is in exsting pay period (ppID should not be false)
        if(ppID){
            updatePayPeriodTotal(ppID, dateString, increment=false); // set increment to false to subtract from pay period total
        }

        // retrieve total hours for the day
        let dayData = timeEntryData[dateString];
        let dayTotal = parseFloat(dayData.dayTotal);
        
        // reset time entry info in time entry object and in local storage (start/end times, break, and day total)
        //  (leave any pay period data intact, since we're currently using it for styling calendar td's)
        saveDayData(dateString, {
            ...timeEntryData[dateString],
            startTime: '', 
            endTime: '', 
            breakDuration: 0, 
            dayTotal: 0
        });
    }
}

function toggleDisabled(selector, disable=true){
    // pass in selector (distinguishes id vs class)
    let btn = $(selector);
    btn.removeClass('disabled');
    if(disable == true){
        btn.addClass('disabled');
    }
    
}

function getResponsiveClasses() {
    console.log('we getting the responsive classes!');
    console.log(window.innerWidth);
    // Add the appropriate responsive classes based on the screen size
    if (window.innerWidth < 576) {
        return 'sm';
    } else if (window.innerWidth < 992) {
        return 'md';
    } else {
        return 'lg';
    }
}





            // function to dynamically add total hours for the day as time is being entered
            function refreshDayTotal(timeInpElement){
                // start time, end time, or break duration was modified...update total hours for day
                console.log("Time changed!");
                let form = timeInpElement.closest('form');

                // retrieve values from form
                let start = form.find('input[name="startTime"]').val();
                let end = form.find('input[name="endTime"]').val();
                let breakTime = form.find('input[name="breakDuration"]').val();
                console.log({start});
                console.log({end});

                // check to see if both start time and end time have been entered before trying to do a bunch of math on an empty string
                if(start != '' && end != ''){
                    console.log('its gonna to okay to update total!');
                    // retrieve date from hidden input
                    let focusDate = form.find('#timeEntryDate').val();
                    console.log({focusDate});

                    // retrieve total input field
                    let total = form.find('input[name="dayTotal"]');

                    // console.log({total});
                    // convert start/end times to datetime objects
                    let startDateTime = new Date(`${focusDate}T${start}:00`);
                    let endDateTime = new Date(`${focusDate}T${end}:00`);
                    // console.log({startDateTime});
                    // console.log({endDateTime});

                    // calculate difference between start and end times (in minutes)
                    let diffMinutes = (endDateTime - startDateTime) / 60000;

                    // accommodate for break time
                    let totalMinutes = diffMinutes - breakTime;

                    // convert minutes to hours/minutes
                    let hours = Math.floor(totalMinutes / 60);
                    let minutes = totalMinutes % 60;

                    // calculate total hours worked
                    let totalTimeWorked = (hours + (minutes / 60)).toFixed(2);

                    // console.log({totalTimeWorked});
                    // populate total field
                    total.val(totalTimeWorked);
                }
            }




        /* form validation functions */
            // function to add/remove invalid feedback styling for a single input
            function invalidInput(element, invalid=true, invalidFeedback=false){
                let parent = element.parent();
                let feedback = parent.find('.invalid-feedback');
                feedback.remove();

                if(invalid){
                    element.addClass('is-invalid');
                    if(invalidFeedback){
                        parent.append(`<div class="invalid-feedback">${invalidFeedback}</div>`);
                    }
                } else {
                    element.removeClass('is-invalid');
                }
            }

            // reset invalid feedback styling for a form
            function resetInvalidForm(form){
                console.log("Resetting invalid form!: " + form);
                form = $(form); // was just for testing
                // remove invalid feedback styling from form
                form.find('.is-invalid').removeClass('is-invalid');
                form.find('.invalid-feedback').remove();
            }

            // reset form values
            function resetForm(form){
                console.log("Resetting form values!: " + form);
                form = $(form); // was just for testing
                // set all form inputs to empty
                form.find('input').val('');
            }

            // quickly populate form with test data via console
            function testDataDay(){
                // populate form with test data
                $('input[name="startTime"]').val('08:00');
                $('input[name="endTime"]').val('16:00');
                $('input[name="breakDuration"]').val('0');
                $('input[name="dayTotal"]').val('8.00');
            }

            // check that start and end times are not empty
            function dayCheckEmptyInputs(){
                let isValid = true;
                // check to make sure start time is not empty
                if($('input[name="startTime"]').val() == ''){
                    invalidInput($('input[name="startTime"]'), true, 'Please enter a start time.');
                    isValid = false;
                }
                // check to make sure end time is not empty
                if($('input[name="endTime"]').val() == ''){
                    invalidInput($('input[name="endTime"]'), true, 'Please enter an end time.');
                    isValid = false;
                }
                return isValid;
            }

            // check that start and end dates are not empty
            function ppCheckEmptyInputs(startString, endString){
                let isValid = true;
                // check to make sure start date is not empty
                if(startString == ''){
                    invalidInput($('#ppStartDate'), true, 'Please enter a start date.');
                    isValid = false;
                }
                // check to make sure end date is not empty
                if(endString == ''){
                    invalidInput($('#ppEndDate'), true, 'Please enter an end date.');
                    isValid = false;
                }
                return isValid;
            }

            // make sure pay period complies with rules before saving
            function payPeriodValidation(ppID, startString, endString, payPeriodData){

                if(startString == '2024-07-28'){
                    console.log('start string is July 28th!');
                    console.log({startString});
                    if(typeof startString == 'string'){
                        console.log('start string is a string!');
                    }else{
                        console.log('start string is NOT a string!');
                    }

                }
                // check to make sure start/end dates are not empty
                if(!ppCheckEmptyInputs(startString, endString)){
                    console.log('empty inputs!');
                    return false;
                }

                // check to make sure start date is before end date
                if(startString >= endString){
                    console.log({startString});
                    console.log({endString});
                    
                    console.log('start date is after end date!');
                    invalidInput($('#ppStartDate'), true, 'Start date must be before end date!');
                    return false;
                }

                // check to make sure start and end dates don't overlap with existing pay periods
                for (const [payPeriodID, ppData] of Object.entries(payPeriodData)) {
                    
                    if(ppID != payPeriodID){ // check to make sure we're not comparing the same pay period
                        // check start date
                        if(startString >= ppData.startDate && startString <= ppData.endDate){
                            // replace alert with a form validation message
                            invalidInput($('#ppStartDate'), true, 'Start date overlaps with existing pay period.');  
                            return false; 
                        }
                        // check end date
                        if(endString >= ppData.startDate && endString <= ppData.endDate){
                            // replace alert with a form validation message
                            invalidInput($('#ppEndDate'), true, 'End date overlaps with existing pay period.');
                            return false;            
                        }
                    }
                }
                return true;
            }
            
            // create a basic unique id generator since we're not using a database at the moment
            function generateUniqueId() {
                return 'id-' + new Date().getTime();
            }

            function usDateFormat(dateString){
                // Split the date string to reformat to us format
                let [year, month, day] = dateString.split("-");
                // Format the date as "MM/DD/YYYY"
                let formattedDate = `${month}/${day}/${year}`;
                return formattedDate;
            }

            function getCalendarWeekNumber(date) {
                // Get the first day of the year
                const startOfYear = new Date(date.getFullYear(), 0, 1);
                
                // Find the first Sunday of the year
                const firstSunday = new Date(startOfYear);
                firstSunday.setDate(firstSunday.getDate() + (7 - firstSunday.getDay()) % 7);
                
                // Calculate the number of days between the date and the first Sunday of the year
                const daysBetween = Math.floor((date - firstSunday) / (24 * 60 * 60 * 1000));
                
                // Calculate the week number
                return Math.floor(daysBetween / 7) + 1;
            }

            // Function to pad a number to two digits
            function padToTwoDigits(number) {
                    return number.toString().padStart(2, '0');
                }

            // retrieve daily time entry data from local storage
            function getStoredDayData(){
                var timeEntryData = localStorage.getItem('timeEntries');
                return timeEntryData ? JSON.parse(timeEntryData) : {};
            }

            // retrieve pay period data from local storage
            function getStoredPayPeriodData(){
                var payPeriodData = localStorage.getItem('payPeriods');
                return payPeriodData ? JSON.parse(payPeriodData) : {};
            }


            // get values for current day, month, and year
            function getCurrentDate(){
                let today = new Date();
                let currentMonth = today.getMonth();
                let currentYear = today.getFullYear();
                let currentDay = today.getDate();
                return {currentMonth, currentYear, currentDay};
            }

            // Function to build the calendar
            function buildCalendar(month=false, year=false){
                // ***probably dont need to pass in display day because if we're looking at a different month, we don't need to know the day
                console.log('building the calendar!');

                // get approximate size of display for variable styling
                let screenSize = getResponsiveClasses();

                let displayMonth;
                let displayYear;
                if(month === false || year === false){
                    // get values of current day/month/year if month/year not passed in
                    let currentDate = getCurrentDate();
                    console.log({currentDate});
                    displayMonth = currentDate.currentMonth;
                    displayYear = currentDate.currentYear;
                    // let displayDay = currentDate.currentDay; // ***might not need this, unless we want to highlight the current day
                }else{
                    // use passed in month/year
                    displayMonth = month;
                    displayYear = year;
                }
                console.log({displayMonth});
                console.log({displayYear});

                // set calendar container
                let calendarDiv = $(".calendarContainer");

                // set up buttons to move between months
                let prevMonth = $('<div class=""><button id="prevMonth" class="changeMonth btn"><i class="fa fa-angle-left fa-lg"></i></button></div>');
                let nextMonth = $('<div class=""><button id="nextMonth" class="changeMonth btn"><i class="fa fa-angle-right fa-lg"></i></button></div>');
                // set up calendar title
                let monthNames = ['January', 'February', 'March', 'April', 'May', 'June','July', 'August', 'September', 'October', 'November', 'December'];
                let calendarTitle = $('<div class="calendar-title mx-3"></div>').text(`${monthNames[displayMonth]} ${displayYear}`);
               
                // append calendar title and buttons to calendar container
                let calendarHead = $('<div class="calendar-head d-flex justify-content-center align-items-center"></div>');
                calendarHead.append(prevMonth);
                calendarHead.append(calendarTitle);
                calendarHead.append(nextMonth);

                calendarDiv.append(calendarHead);'s'

                // set up calendar table
                let daysInMonth = new Date(displayYear, displayMonth + 1, 0).getDate();
                let firstDayInMonth = new Date(displayYear, displayMonth, 1).getDay();
                // console.log({daysInMonth});                
                // console.log({firstDayInMonth});
                let tbl = $(`<table class="calendar table table-cell-hover table-cell-focus border-muted" id="myCalendar" data-month="${displayMonth}" data-year="${displayYear}"></table>`);
                let tblHead = $('<thead></thead>');
                let tblBody = $('<tbody></tbody>');
                
                // set up table header
                // let daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat','Pay Period Total'];
                let daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                let headerRow = $('<tr class="text-center"></tr>');
                $.each(daysOfWeek, (i, v) => {
                    let th = $('<th class="dow"></th>').text(v);
                    headerRow.append(th);
                })
                headerRow.append($('<th class="pp-total"></th>').text('Pay Period Total'));

                tblHead.append(headerRow);
                
                // get stored pay period data so we can populate the calendar with pay period totals and style the pay period dates
                let ppData = AppData.payPeriodData;
                // set up table body
                let dx = 1;
                for (let i = 0; i < 6; i++) {
                    // console.log("--------------------");
                    let bodyRow = $('<tr></tr>');
                    let payPeriodTotal = false; // initialize pay period total variable for this week (should ideally only have one pay period total per week)
                    let ppTotalHtml = ''; // initialize pay period total html for this week (append to this string if there are multiple pay periods ending in the same week)

                    for (let j = 0; j < 7; j++) {
                        // console.log("j is: " + j);
                        let dateString = `${displayYear}-${padToTwoDigits(displayMonth + 1)}-${padToTwoDigits(dx)}`;
                        
                        if(dateString == '2024-08-06'){
                            console.log("this is the day!");
                            console.log({dateString});
                        }
                        let weekNum = getCalendarWeekNumber(new Date(dateString));                
                        let cell = $(`<td class="cal-day" data-date="${dateString}"></td>`);
                        if (i === 0 && j < firstDayInMonth) {
                            cell.text('');
                        } else if (dx <= daysInMonth) {
                            cell.dayDate = dx;
                            cell.html(`<div class="date-num">${dx}</div>
                                        <div class="te-amt timeEntryCont"></div>`);
                            let timeEntryData = AppData.timeEntryData;
                            // console.log({timeEntryData});

                            if(dateString == '2024-08-06'){ console.log({timeEntryData}); }
                            // if there is no data for this day, create a new object with default values
                            let dayData;
                            if(timeEntryData[dateString]){ 
                                dayData = timeEntryData[dateString];
                            } else { 
                                dayData = {
                                    startTime: '', 
                                    endTime: '', 
                                    breakDuration: 0, 
                                    dayTotal: 0
                                }; // don't want to display dayTotal if it's 0
                            }
                            // console.log({dateString});
                            // console.log({dayData});

                            // populate cell with day data
                            if(dayData.dayTotal && dayData.dayTotal != 0){
                                let tsCont = cell.find('.timeEntryCont');

                                if(screenSize == 'sm'){
                                    // round day total to 1 decimal place
                                    let roundDayTotal = parseFloat(dayData.dayTotal).toFixed(1);
                                    tsCont.html(`${roundDayTotal}`);
                                }else{
                                    tsCont.html(`${dayData.dayTotal} hrs`);
                                }
                                
                            }

                            // pay period related data/styling
                            // check to see if this day is part of a pay period (time entry record will have a ppID if it is part of a pay period)
                            let ppID = false;
                            if(dayData.ppID && dayData.ppID != ''){
                                dayPpID = dayData.ppID;
                                // console.log({dayPpID});

                                // style the cell depending on position within pay period
                                // cell.addClass('pp-day'); // prolly dont need this extra class
                                // if this day is the end of a pay period add total hours worked during pay period to content for the final cell in the row
                                if(ppData[dayPpID] && ppData[dayPpID].endDate == dateString){
                                    // add pay period total to pay period total cell at end of this row if this day is the end of a pay period
                                    payPeriodTotal = ppData[dayPpID].total; 
                                    // if there is a pay period that ends within this week add total amt to pp total cell (even if it is 0, since the link allows us to edit the pay period)
                                    if(typeof payPeriodTotal === 'number' && payPeriodTotal !== false){
                                        // add to html string for pay period total cell in case there are multiple pay periods ending in the same week
                                        // let ppRange = `${ppData[dayPpID].startDate} to ${ppData[dayPpID].endDate}`;

                                        let formattedStartDate = usDateFormat(ppData[dayPpID].startDate);
                                        let formattedEndDate = usDateFormat(ppData[dayPpID].endDate);
                                        let ppRange = `${formattedStartDate} to ${formattedEndDate}`;
                                        ppTotalHtml += `<div><a class="ppTotalLink" title="${ppRange}" data-enddate="${dateString}" data-ppid="${dayPpID}">${payPeriodTotal} hrs</a></div>`;
                                    }
                                    // add class to style day in pay period
                                    cell.addClass('pp-end');
                                } else if(ppData[dayPpID] && ppData[dayPpID].startDate == dateString){
                                    cell.addClass('pp-start');
                                } else {
                                    cell.addClass('pp-middle');
                                }
                            }

                            // increment date
                            dx++;
                        }

                        bodyRow.append(cell);

                        // if there are 7 cells in the row, add the weekly total and pay period total cells
                        if(j === 6){
                            // add final column(s) to row (weekly total and pay period total)
                            bodyRow.append(`<td class="pp-total">${ppTotalHtml}</td>`);
                        }
                    }

                    tblBody.append(bodyRow);
                }

                tbl.append(tblHead);
                tbl.append(tblBody);
                calendarDiv.append(tbl);
            }

      


            // function getFormattedDateString(dateObj) {
            //     // const date = new Date();

            //     let day = String(dateObj.getDate()).padStart(2, '0');
            //     let month = String(dateObj.getMonth() + 1).padStart(2, '0'); // Months are zero-based
            //     let year = dateObj.getFullYear();

            //     let formattedDate = `${year}-${month}-${day}`;
            //     console.log(formattedDate); // Example output: "2024-05-30"
            //     return formattedDate;
            // }
            


                        // function getCalendarWeekNumber_v3(date) {
            //     console.log({date});
            //     let startOfYear = new Date(date.getFullYear(), 0, 1);
            //     console.log({startOfYear});
            //     // Adjust startOfYear to the first Sunday of the year
            //     let firstSunday = new Date(startOfYear.setDate(startOfYear.getDate() - startOfYear.getDay() + 7));
            //     console.log({firstSunday});
            //     // Calculate the number of days between the date and the first Sunday of the year
            //     let daysBetween = Math.floor((date - firstSunday) / (24 * 60 * 60 * 1000));
            //     console.log({daysBetween});
            //     // Calculate the week number
            //     return Math.floor(daysBetween / 7) + 1;
            // }

    </script>


</body>
</html>

